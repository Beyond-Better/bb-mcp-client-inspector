# Version Management

This document explains how version management works in the MCP Client Inspector
project.

## Overview

The project uses a **centralized version management system** where:

1. **Root `deno.jsonc`** is the **single source of truth** (required for JSR
   publishing)
2. **`scripts/update-version.ts`** reads deno.jsonc and generates
   `shared/version.ts`
3. **All TypeScript code** imports from `shared/version.ts`
4. **GitHub Actions** automatically runs the update script before publishing

## Architecture

```
deno.jsonc (v1.0.0)
       ↓
[scripts/update-version.ts]
       ↓
shared/version.ts
       ↓
   ┌────────┴────────┐
   ↓                 ↓
mcp-server/       fresh-ui/
ConsoleManager    Console.tsx
dependencyHelper
```

## Single Source of Truth: `deno.jsonc`

The version is defined in the root `deno.jsonc`:

```jsonc
{
  "name": "@beyondbetter/mcp-client-inspector",
  "version": "1.0.0" // <-- SINGLE SOURCE OF TRUTH
  // ...
}
```

**Why deno.jsonc?**

- Required by JSR for package publishing
- Cannot be imported into TypeScript (JSON with comments)
- Must be kept in sync for publishing to work

## Generated File: `shared/version.ts`

**DO NOT EDIT THIS FILE MANUALLY** - It's auto-generated by
`scripts/update-version.ts`.

The script reads `deno.jsonc` and generates:

```typescript
export const VERSION = '1.0.0';
export const PACKAGE_NAME = '@beyondbetter/mcp-client-inspector';
export const FULL_VERSION = `${PACKAGE_NAME}@${VERSION}`;

export function parseVersion(): {
  major: number;
  minor: number;
  patch: number;
  prerelease?: string;
} {
  // Parses version into components
}
```

## Usage in Code

All TypeScript files import from `shared/version.ts`:

### Example 1: ConsoleManager.ts

```typescript
import { VERSION } from '@shared/types/../version.ts';

this.sendToClient(connectionId, {
  type: 'connection_established',
  payload: {
    connectionId,
    serverVersion: VERSION, // Uses imported VERSION
  },
  timestamp: Date.now(),
});
```

### Example 2: Console.tsx

```typescript
import { VERSION } from '@shared/types/../version.ts';

<footer>
  <p>MCP Client Inspector v{VERSION} | Beyond Better</p>
</footer>;
```

### Example 3: dependencyHelper.ts

```typescript
import { VERSION } from "@shared/types/../version.ts";

serverConfig: {
  name: "mcp-client-inspector",
  version: VERSION,  // Uses imported VERSION
}
```

## Updating the Version

### Manual Update (Development)

1. **Update `deno.jsonc`:**
   ```jsonc
   {
     "version": "1.0.1" // Change this
   }
   ```

2. **Run the update script:**
   ```bash
   deno task update-version
   ```

3. **Result:**
   - `shared/version.ts` is regenerated
   - All code now uses "1.0.1"
   - No code changes needed!

### Automated Update (GitHub Actions)

When publishing via GitHub Actions, the version is automatically updated:

```yaml
# In .github/workflows/publish.yaml

- name: Extract version from tag
  run: |
    VERSION=${GITHUB_REF#refs/tags/v}
    echo "version=$VERSION" >> $GITHUB_OUTPUT

- name: Update version in deno.jsonc
  run: |
    sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" deno.jsonc

- name: Generate version.ts from deno.jsonc
  run: deno task update-version

- name: Publish to JSR
  run: deno publish --allow-dirty
```

**Process:**

1. Tag pushed: `v1.0.1`
2. Workflow extracts: `1.0.1`
3. Updates `deno.jsonc`: `"version": "1.0.1"`
4. Runs: `deno task update-version`
5. Generates: `shared/version.ts` with `VERSION = "1.0.1"`
6. Publishes to JSR

## Files Using VERSION

Currently, version is used in:

1. **`mcp-server/src/console/ConsoleManager.ts`**
   - Line: `serverVersion: VERSION`
   - Purpose: Sent to UI in connection_established message

2. **`fresh-ui/islands/Console.tsx`**
   - Line: `MCP Client Inspector v{VERSION}`
   - Purpose: Displayed in footer

3. **`mcp-server/src/dependencyHelper.ts`**
   - Line: `version: VERSION`
   - Purpose: Server configuration metadata

## Adding New Version References

To use version in new code:

```typescript
// Add import
import { VERSION } from '@shared/types/../version.ts';

// Use directly
const myVersion = VERSION; // "1.0.0"

// Or use full version
import { FULL_VERSION } from '@shared/types/../version.ts';
const full = FULL_VERSION; // "@beyondbetter/mcp-client-inspector@1.0.0"

// Or parse components
import { parseVersion } from '@shared/types/../version.ts';
const { major, minor, patch } = parseVersion(); // { major: 1, minor: 0, patch: 0 }
```

## Workflow Integration

### Development Workflow

```bash
# 1. Make code changes
vim src/some-file.ts

# 2. Update version when ready for release
vim deno.jsonc  # Change "version": "1.0.1"

# 3. Generate version.ts
deno task update-version

# 4. Commit everything
git add .
git commit -m "Bump version to 1.0.1"

# 5. Create tag
git tag v1.0.1
git push origin v1.0.1

# 6. GitHub Actions handles the rest!
```

### Release Workflow

When you push a git tag:

1. **GitHub Actions triggered**
2. **Version extracted** from tag (`v1.0.1` → `1.0.1`)
3. **deno.jsonc updated** to match tag
4. **version.ts regenerated** from deno.jsonc
5. **Tests run** with new version
6. **Published to JSR** if tests pass

## Troubleshooting

### Problem: Version mismatch between files

**Symptoms:**

- `deno.jsonc` shows `1.0.1`
- `shared/version.ts` shows `1.0.0`
- UI displays old version

**Solution:**

```bash
deno task update-version
```

### Problem: version.ts not imported correctly

**Symptoms:**

- TypeScript errors: "Cannot find module"
- Import path issues

**Solution:** Use the correct import path:

```typescript
// ✅ CORRECT
import { VERSION } from '@shared/types/../version.ts';

// ❌ WRONG
import { VERSION } from '../../shared/version.ts';
import { VERSION } from '@shared/version.ts';
```

### Problem: Workflow fails on version update

**Symptoms:**

- GitHub Actions fails at "Generate version.ts" step
- Error: "Cannot find deno.jsonc"

**Solution:** Ensure the workflow has correct working directory:

```yaml
- name: Generate version.ts from deno.jsonc
  run: deno task update-version
  # Should run from repository root
```

## Benefits of This System

### ✅ Advantages

1. **Single Source of Truth**
   - Version defined once in `deno.jsonc`
   - Required for JSR anyway
   - No manual synchronization needed

2. **Type-Safe**
   - TypeScript constant exported
   - Compile-time checking
   - No runtime string parsing

3. **Automated**
   - GitHub Actions handles updates
   - No manual file editing during release
   - Consistent across all deployments

4. **DRY (Don't Repeat Yourself)**
   - Write version once
   - Use everywhere
   - Update once, propagates everywhere

5. **Easy to Maintain**
   - Clear process
   - Simple script
   - Well-documented

### ⚠️ Considerations

1. **Must run update script**
   - After changing `deno.jsonc`
   - Before committing
   - Workflow does this automatically

2. **Import path quirk**
   - Uses `@shared/types/../version.ts` path
   - Because `@shared/types/` is mapped in import_map
   - `../` goes up to `shared/` level

3. **Generated file in git**
   - `shared/version.ts` is committed
   - Could be `.gitignore`d and generated on build
   - Kept in git for transparency

## Alternative Approaches Considered

### ❌ Multiple version.ts files

**Rejected because:**

- Each component would have its own version
- Versions could drift apart
- More files to maintain

### ❌ Runtime JSON parsing

**Rejected because:**

- Can't import JSONC in TypeScript
- Would need Node.js-style require
- Runtime overhead
- No type safety

### ❌ Environment variables

**Rejected because:**

- Not available at build time
- Complicates deployment
- Harder to track in code

### ✅ Auto-generated TypeScript (CHOSEN)

**Benefits:**

- Single source of truth (deno.jsonc)
- Type-safe imports
- No runtime overhead
- Works with JSR requirements

## Summary

**Simple workflow:**

1. Update `deno.jsonc` version
2. Run `deno task update-version`
3. Commit and tag
4. Push tag to GitHub
5. GitHub Actions publishes automatically

**Result:**

- Version synchronized everywhere
- No manual file editing
- Type-safe and maintainable
- Works seamlessly with JSR

---

**See Also:**

- [PUBLISHING.md](./PUBLISHING.md) - Release process
- [scripts/update-version.ts](./scripts/update-version.ts) - Update script
- [shared/version.ts](./shared/version.ts) - Generated file
